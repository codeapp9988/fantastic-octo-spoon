<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #1a1a1a;
            padding: 40px;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            margin-bottom: 40px;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #6b7280;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 1px;
        }

        .color-purple { background-color: #7c6baf; }
        .color-orange { background-color: #f4845f; }
        .color-teal { background-color: #5eccc3; }
        .color-yellow { background-color: #f6c244; }
        .color-pink { background-color: #b87b8f; }
        .color-blue { background-color: #6fa8dc; }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 50px;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-button {
            background-color: transparent;
            border: none;
            color: #1a1a1a;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .dropdown-button:hover {
            background-color: #f3f4f6;
        }

        .dropdown-arrow {
            width: 6px;
            height: 6px;
            border-right: 2px solid #1a1a1a;
            border-bottom: 2px solid #1a1a1a;
            transform: rotate(45deg);
            transition: transform 0.2s;
            margin-left: 6px;
            margin-top: -3px;
        }

        .dropdown.open .dropdown-arrow {
            transform: rotate(-135deg);
            margin-top: 2px;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            padding: 4px 0;
        }

        .dropdown.open .dropdown-menu {
            display: block;
        }

        .dropdown-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #6b7280;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f3f4f6;
        }

        .dropdown-item.active {
            color: #1a1a1a;
            background-color: #e5e7eb;
        }

        .chart-container {
            background-color: #ffffff;
        }

        .metric-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            position: relative;
        }

        .metric-label {
            width: 200px;
            text-align: right;
            padding-right: 20px;
            font-size: 14px;
            color: #6b7280;
            font-weight: 400;
        }

        .metric-bar-container {
            flex: 1;
            position: relative;
            height: 20px;
            display: flex;
            align-items: center;
            max-width: 900px;
        }

        .metric-bar {
            height: 18px;
            border-radius: 3px;
            position: relative;
            transition: all 0.3s ease;
            min-width: 20px;
            cursor: pointer;
        }

        .metric-value {
            margin-left: 12px;
            font-size: 14px;
            color: #1a1a1a;
            font-weight: 400;
            white-space: nowrap;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
            transition: background-color 0.2s;
        }

        .metric-value:hover {
            background-color: #f3f4f6;
        }

        /* Exact metric styling from image */
        .registrations .metric-bar {
            background-color: #f4845f;
        }

        .ftds .metric-bar {
            background-color: #f6c244;
        }

        .deposits-count .metric-bar {
            background-color: #5eccc3;
        }

        .deposits-value .metric-bar {
            background-color: #b87b8f;
        }

        .unique-depositors .metric-bar {
            background-color: #7c6baf;
        }

        .accurate-ftds .metric-bar {
            background-color: #6fa8dc;
        }

        .add-metric-btn {
            background-color: #f3f4f6;
            border: 2px dashed #d1d5db;
            color: #6b7280;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
            transition: all 0.2s;
        }

        .add-metric-btn:hover {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }

        .toolbar {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #ffffff;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .toolbar button {
            background-color: #f3f4f6;
            border: none;
            color: #1a1a1a;
            padding: 8px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .toolbar button:hover {
            background-color: #e5e7eb;
        }

        .input-field {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            color: #1a1a1a;
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 14px;
            width: 80px;
        }

        .input-field:focus {
            outline: none;
            border-color: #9ca3af;
        }

        /* Canvas for export */
        #exportCanvas {
            display: none;
        }

        /* Color picker styles */
        .color-picker-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            display: none;
        }

        .color-picker-container h3 {
            margin-bottom: 15px;
            color: #1a1a1a;
            font-size: 16px;
        }

        .color-picker-container input[type="color"] {
            width: 50px;
            height: 50px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            cursor: pointer;
        }

        .color-picker-container .buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .color-picker-container button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .color-picker-container .apply-btn {
            background-color: #3b82f6;
            color: white;
        }

        .color-picker-container .cancel-btn {
            background-color: #e5e7eb;
            color: #1a1a1a;
        }

        .metric-bar:hover::after {
            content: 'Click to change color';
            position: absolute;
            top: -30px;
            left: 0;
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button onclick="exportToPNG()">Export PNG</button>
        <button onclick="exportData()">Export Data</button>
        <button onclick="addMetric()">Add Metric</button>
        <button onclick="resetChart()">Reset</button>
    </div>

    <div class="dashboard" id="dashboard">
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color color-purple"></div>
                <span>Unique Depositors</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-orange"></div>
                <span>Registrations</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-teal"></div>
                <span>Number of Deposits</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-yellow"></div>
                <span>FTDs</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-pink"></div>
                <span>Deposits $ Value</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-blue"></div>
                <span>Accurate FTDs</span>
            </div>
        </div>

        <div class="controls">
            <div class="dropdown" id="metricDropdown">
                <button class="dropdown-button" onclick="toggleDropdown('metricDropdown')">
                    <span>Metric</span>
                    <div class="dropdown-arrow"></div>
                </button>
                <div class="dropdown-menu">
                    <div class="dropdown-item active" onclick="selectMetric('all')">All Metrics</div>
                    <div class="dropdown-item" onclick="selectMetric('registrations')">Registrations</div>
                    <div class="dropdown-item" onclick="selectMetric('ftds')">FTDs</div>
                    <div class="dropdown-item" onclick="selectMetric('deposits')">Deposits</div>
                    <div class="dropdown-item" onclick="selectMetric('unique')">Unique Depositors</div>
                </div>
            </div>

            <div class="dropdown" id="valueDropdown">
                <button class="dropdown-button" onclick="toggleDropdown('valueDropdown')">
                    <span>Value</span>
                    <div class="dropdown-arrow"></div>
                </button>
                <div class="dropdown-menu">
                    <div class="dropdown-item active" onclick="selectValue('absolute')">Absolute Values</div>
                    <div class="dropdown-item" onclick="selectValue('percentage')">Percentage</div>
                    <div class="dropdown-item" onclick="selectValue('normalized')">Normalized</div>
                    <div class="dropdown-item" onclick="selectValue('logarithmic')">Logarithmic</div>
                </div>
            </div>
        </div>

        <div class="chart-container" id="chartContainer">
            <div class="metric-row registrations">
                <div class="metric-label">Registrations</div>
                <div class="metric-bar-container">
                    <div class="metric-bar" onclick="openColorPicker(this)"></div>
                    <div class="metric-value" onclick="editValue(this)" data-original="77">77</div>
                </div>
            </div>

            <div class="metric-row ftds">
                <div class="metric-label">FTDs</div>
                <div class="metric-bar-container">
                    <div class="metric-bar" onclick="openColorPicker(this)"></div>
                    <div class="metric-value" onclick="editValue(this)" data-original="51">51</div>
                </div>
            </div>

            <div class="metric-row deposits-count">
                <div class="metric-label">Number of Deposits</div>
                <div class="metric-bar-container">
                    <div class="metric-bar" onclick="openColorPicker(this)"></div>
                    <div class="metric-value" onclick="editValue(this)" data-original="185">185</div>
                </div>
            </div>

            <div class="metric-row deposits-value">
                <div class="metric-label">Deposits $ Value</div>
                <div class="metric-bar-container">
                    <div class="metric-bar" onclick="openColorPicker(this)"></div>
                    <div class="metric-value" onclick="editValue(this)" data-original="51890">51.89K</div>
                </div>
            </div>

            <div class="metric-row unique-depositors">
                <div class="metric-label">Unique Depositors</div>
                <div class="metric-bar-container">
                    <div class="metric-bar" onclick="openColorPicker(this)"></div>
                    <div class="metric-value" onclick="editValue(this)" data-original="51">51</div>
                </div>
            </div>

            <div class="metric-row accurate-ftds">
                <div class="metric-label">Accurate FTDs</div>
                <div class="metric-bar-container">
                    <div class="metric-bar" onclick="openColorPicker(this)"></div>
                    <div class="metric-value" onclick="editValue(this)" data-original="51">51</div>
                </div>
            </div>
        </div>

        <button class="add-metric-btn" onclick="addMetric()">+ Add New Metric</button>
    </div>

    <canvas id="exportCanvas"></canvas>

    <!-- Color picker modal -->
    <div class="color-picker-container" id="colorPicker">
        <h3>Choose Bar Color</h3>
        <input type="color" id="colorInput" value="#fb923c">
        <div class="buttons">
            <button class="apply-btn" onclick="applyColor()">Apply</button>
            <button class="cancel-btn" onclick="closeColorPicker()">Cancel</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        let chartData = {
            'Registrations': 77,
            'FTDs': 51,
            'Number of Deposits': 185,
            'Deposits $ Value': 51890,
            'Unique Depositors': 51,
            'Accurate FTDs': 51
        };

        let currentValueType = 'absolute';
        let currentBarElement = null;

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.dropdown');
            
            // Close other dropdowns
            allDropdowns.forEach(dd => {
                if (dd.id !== dropdownId) {
                    dd.classList.remove('open');
                }
            });
            
            dropdown.classList.toggle('open');
        }

        function selectMetric(metric) {
            const dropdown = document.getElementById('metricDropdown');
            const button = dropdown.querySelector('.dropdown-button span');
            const items = dropdown.querySelectorAll('.dropdown-item');
            
            items.forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            button.textContent = event.target.textContent;
            dropdown.classList.remove('open');
            
            filterMetrics(metric);
        }

        function selectValue(value) {
            const dropdown = document.getElementById('valueDropdown');
            const button = dropdown.querySelector('.dropdown-button span');
            const items = dropdown.querySelectorAll('.dropdown-item');
            
            items.forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            button.textContent = event.target.textContent;
            dropdown.classList.remove('open');
            
            currentValueType = value;
            updateValueDisplay(value);
        }

        function filterMetrics(filter) {
            const rows = document.querySelectorAll('.metric-row');
            
            rows.forEach(row => {
                if (filter === 'all') {
                    row.style.display = 'flex';
                } else {
                    const shouldShow = row.classList.contains(filter) || 
                                     row.querySelector('.metric-label').textContent.toLowerCase().includes(filter);
                    row.style.display = shouldShow ? 'flex' : 'none';
                }
            });
        }

        function updateValueDisplay(type) {
            const maxValue = Math.max(...Object.values(chartData));
            
            document.querySelectorAll('.metric-row').forEach(row => {
                const label = row.querySelector('.metric-label').textContent;
                const value = chartData[label] || 0;
                const valueElement = row.querySelector('.metric-value');
                const bar = row.querySelector('.metric-bar');
                
                let displayValue;
                let barWidth;
                
                switch(type) {
                    case 'percentage':
                        const percentage = maxValue > 0 ? ((value / maxValue) * 100).toFixed(1) : 0;
                        displayValue = percentage + '%';
                        barWidth = percentage + '%';
                        break;
                    case 'normalized':
                        const normalized = maxValue > 0 ? (value / maxValue).toFixed(3) : 0;
                        displayValue = normalized;
                        barWidth = (normalized * 100) + '%';
                        break;
                    case 'logarithmic':
                        if (value > 0) {
                            const log = Math.log10(value).toFixed(2);
                            displayValue = '10^' + log;
                            barWidth = ((Math.log10(value) / Math.log10(maxValue)) * 100) + '%';
                        } else {
                            displayValue = '0';
                            barWidth = '0%';
                        }
                        break;
                    default:
                        displayValue = formatNumber(value);
                        barWidth = maxValue > 0 ? ((value / maxValue) * 100) + '%' : '0%';
                }
                
                valueElement.textContent = displayValue;
                bar.style.width = barWidth;
            });
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                const millions = num / 1000000;
                if (millions % 1 === 0) {
                    return millions + 'M';
                }
                return millions.toFixed(2).replace(/\.?0+$/, '') + 'M';
            } else if (num >= 1000) {
                const thousands = num / 1000;
                if (thousands % 1 === 0) {
                    return thousands + 'K';
                }
                return thousands.toFixed(2).replace(/\.?0+$/, '') + 'K';
            }
            return num.toLocaleString();
        }

        function parseDisplayValue(displayValue) {
            // Remove commas and parse multipliers
            const cleanValue = displayValue.replace(/,/g, '').trim();
            
            if (cleanValue.includes('M') || cleanValue.includes('m')) {
                return parseFloat(cleanValue) * 1000000;
            } else if (cleanValue.includes('K') || cleanValue.includes('k')) {
                return parseFloat(cleanValue) * 1000;
            } else if (cleanValue.includes('%')) {
                return parseFloat(cleanValue);
            }
            return parseFloat(cleanValue) || 0;
        }

        function editValue(element) {
            const currentValue = element.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.className = 'input-field';
            
            element.style.display = 'none';
            element.parentNode.insertBefore(input, element);
            input.focus();
            input.select();
            
            function saveValue() {
                const newValue = input.value.trim();
                if (newValue) {
                    // Parse the new value
                    const numValue = parseDisplayValue(newValue);
                    
                    // Update chart data
                    const label = element.closest('.metric-row').querySelector('.metric-label').textContent;
                    chartData[label] = numValue;
                    
                    // Format and display
                    element.textContent = formatNumber(numValue);
                    
                    // Update the chart to recalculate bar widths
                    updateChart();
                }
                element.style.display = 'block';
                input.remove();
            }
            
            input.addEventListener('blur', saveValue);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveValue();
                }
            });
        }

        function updateChart() {
            updateValueDisplay(currentValueType);
        }

        function addMetric() {
            const name = prompt('Enter metric name:');
            if (!name) return;
            
            const value = prompt('Enter value:');
            if (!value) return;
            
            const numValue = parseDisplayValue(value);
            chartData[name] = numValue;
            
            const colors = ['#64748b', '#059669', '#dc2626', '#7c2d12', '#1d4ed8', '#6d28d9'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            const chartContainer = document.getElementById('chartContainer');
            const newRow = document.createElement('div');
            newRow.className = 'metric-row custom-metric';
            newRow.innerHTML = `
                <div class="metric-label">${name}</div>
                <div class="metric-bar-container">
                    <div class="metric-bar" style="background-color: ${randomColor};" onclick="openColorPicker(this)"></div>
                    <div class="metric-value" onclick="editValue(this)" data-original="${numValue}">${formatNumber(numValue)}</div>
                </div>
            `;
            
            chartContainer.appendChild(newRow);
            updateChart();
        }

        function exportToPNG() {
            const dashboard = document.getElementById('dashboard');
            
            html2canvas(dashboard, {
                backgroundColor: '#ffffff',
                scale: 2,
                logging: false,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                // Create download link
                const link = document.createElement('a');
                link.download = 'dashboard-chart.png';
                link.href = canvas.toDataURL();
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).catch(err => {
                console.error('Export failed:', err);
                alert('Export failed. Please try again.');
            });
        }

        function exportData() {
            const data = {
                chartData: chartData,
                timestamp: new Date().toISOString(),
                valueType: currentValueType
            };
            
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chart-data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function resetChart() {
            chartData = {
                'Registrations': 77,
                'FTDs': 51,
                'Number of Deposits': 185,
                'Deposits $ Value': 51890,
                'Unique Depositors': 51,
                'Accurate FTDs': 51
            };
            
            // Remove custom metrics
            document.querySelectorAll('.custom-metric').forEach(el => el.remove());
            
            // Reset dropdowns
            document.getElementById('metricDropdown').querySelector('.dropdown-button span').textContent = 'Metric';
            document.getElementById('valueDropdown').querySelector('.dropdown-button span').textContent = 'Value';
            
            // Reset all metric rows to visible
            document.querySelectorAll('.metric-row').forEach(row => {
                row.style.display = 'flex';
            });
            
            currentValueType = 'absolute';
            updateChart();
        }

        function openColorPicker(barElement) {
            currentBarElement = barElement;
            const currentColor = window.getComputedStyle(barElement).backgroundColor;
            
            // Convert RGB to hex
            const rgb = currentColor.match(/\d+/g);
            if (rgb) {
                const hex = '#' + rgb.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
                document.getElementById('colorInput').value = hex;
            }
            
            document.getElementById('colorPicker').style.display = 'block';
        }

        function closeColorPicker() {
            document.getElementById('colorPicker').style.display = 'none';
            currentBarElement = null;
        }

        function applyColor() {
            if (currentBarElement) {
                const newColor = document.getElementById('colorInput').value;
                currentBarElement.style.backgroundColor = newColor;
                
                // Update legend if it's a default metric
                const row = currentBarElement.closest('.metric-row');
                const label = row.querySelector('.metric-label').textContent;
                updateLegendColor(label, newColor);
            }
            closeColorPicker();
        }

        function updateLegendColor(metricName, color) {
            const legendItems = document.querySelectorAll('.legend-item');
            legendItems.forEach(item => {
                const text = item.querySelector('span').textContent;
                if (text.includes(metricName.split(' ')[0]) || metricName.includes(text.split(' ')[0])) {
                    const colorDiv = item.querySelector('.legend-color');
                    colorDiv.style.backgroundColor = color;
                }
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown').forEach(dd => {
                    dd.classList.remove('open');
                });
            }
        });

        // Initialize chart
        updateChart();
    </script>
</body>
</html>
